<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Portfolio Analyst</title>
<script src="https://wealthica.github.io/wealthica.js/dist/addon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e17;
    --bg-secondary: #111827;
    --bg-card: #1a2234;
    --bg-card-hover: #1f2a3f;
    --border: #2a3550;
    --border-accent: #3b82f6;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent: #3b82f6;
    --accent-glow: rgba(59, 130, 246, 0.15);
    --green: #22c55e;
    --green-bg: rgba(34, 197, 94, 0.1);
    --red: #ef4444;
    --red-bg: rgba(239, 68, 68, 0.1);
    --yellow: #f59e0b;
    --yellow-bg: rgba(245, 158, 11, 0.1);
    --purple: #a855f7;
    --purple-bg: rgba(168, 85, 247, 0.1);
    --cyan: #06b6d4;
    --pink: #ec4899;
    --orange: #f97316;
    --teal: #14b8a6;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; width: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    top: -200px; right: -200px;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(59,130,246,0.06) 0%, transparent 70%);
    pointer-events: none; z-index: 0;
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 20px; position: relative; z-index: 1; }

  /* Header */
  .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo-mark { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #7c3aed); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: white; box-shadow: 0 4px 16px rgba(59,130,246,0.25); }
  .header h1 { font-size: 20px; font-weight: 600; letter-spacing: -0.3px; }
  .header h1 span { color: var(--accent); }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .btn-settings { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
  .btn-settings:hover { border-color: var(--accent); color: var(--text-primary); background: var(--bg-card-hover); }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); transition: background 0.3s; }
  .status-dot.connected { background: var(--green); box-shadow: 0 0 8px rgba(34,197,94,0.4); }
  .status-dot.error { background: var(--red); }

  /* Settings Panel */
  .settings-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; display: none; animation: slideDown 0.2s ease-out; }
  .settings-panel.visible { display: block; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  .settings-panel label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .settings-panel .input-row { display: flex; gap: 10px; }
  .settings-panel input { flex: 1; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 14px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 13px; outline: none; transition: border-color 0.2s; }
  .settings-panel input:focus { border-color: var(--accent); }
  .settings-panel .hint { font-size: 12px; color: var(--text-muted); margin-top: 8px; line-height: 1.5; }
  .settings-panel .hint a { color: var(--accent); text-decoration: none; }

  /* Tab Navigation */
  .tab-nav { display: flex; gap: 2px; margin-bottom: 20px; border-bottom: 1px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .tab-nav::-webkit-scrollbar { display: none; }
  .tab-btn { padding: 10px 18px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
  .tab-btn:hover { color: var(--text-primary); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* Filter Bar */
  .filter-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .filter-bar label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .filter-bar select { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 6px 12px; border-radius: 6px; font-family: inherit; font-size: 12px; cursor: pointer; outline: none; }
  .filter-bar select:focus { border-color: var(--accent); }

  /* Risk Slider */
  .risk-slider-wrap { display: flex; align-items: center; gap: 12px; margin-left: auto; }
  .risk-slider-wrap label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
  .risk-slider { -webkit-appearance: none; appearance: none; width: 120px; height: 6px; border-radius: 3px; background: linear-gradient(90deg, var(--green), var(--yellow), var(--red)); outline: none; cursor: pointer; }
  .risk-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: white; border: 2px solid var(--accent); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
  .risk-slider::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: white; border: 2px solid var(--accent); cursor: pointer; }
  .risk-level-label { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; min-width: 90px; }

  /* Buttons */
  .btn-primary { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-family: inherit; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-accent { background: linear-gradient(135deg, var(--accent), var(--purple)); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-accent:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(59,130,246,0.3); }
  .btn-accent:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* Tab Panels */
  .tab-panel { display: none; animation: fadeIn 0.3s ease; }
  .tab-panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* Summary Cards */
  .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .summary-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; transition: border-color 0.2s; }
  .summary-card:hover { border-color: var(--border-accent); }
  .summary-card .label { font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px; }
  .summary-card .value { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; font-family: 'JetBrains Mono', monospace; }
  .summary-card .sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
  .positive { color: var(--green); }
  .negative { color: var(--red); }

  /* Score Banner */
  .score-banner { display: flex; align-items: center; gap: 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
  .score-ring { position: relative; width: 100px; height: 100px; flex-shrink: 0; }
  .score-ring .ring-bg { fill: none; stroke: var(--border); stroke-width: 8; }
  .score-ring .ring-fill { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s ease, stroke 0.5s; }
  .score-ring .score-text { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; fill: var(--text-primary); text-anchor: middle; dominant-baseline: central; }
  .score-details h2 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
  .score-details p { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

  /* Chart Cards */
  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .chart-card h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 16px; font-weight: 500; }
  .chart-card canvas { max-height: 280px; }

  /* Accounts Grid */
  .accounts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-bottom: 20px; }
  .account-chip { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; font-size: 12px; }
  .account-chip .acct-name { font-weight: 500; color: var(--text-primary); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .account-chip .acct-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; color: var(--accent); }

  /* Holdings Controls */
  .holdings-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
  .holdings-controls select { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; font-family: inherit; font-size: 13px; cursor: pointer; outline: none; }

  /* Holdings Grid */
  .holdings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
  .position-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; transition: all 0.2s; }
  .position-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(59,130,246,0.1); }
  .pos-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .pos-symbol { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 15px; }
  .pos-name { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
  .pos-account { font-size: 10px; color: var(--text-muted); background: var(--bg-primary); padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
  .pos-values { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
  .pos-metric .pm-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; }
  .pos-metric .pm-value { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 500; }
  .pos-weight-bar { height: 4px; background: var(--bg-primary); border-radius: 2px; margin-top: 10px; overflow: hidden; }
  .pos-weight-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; background: var(--accent); }
  .pos-weight-label { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

  /* Rating Badge */
  .rating-badge { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 14px; flex-shrink: 0; }
  .rating-badge.excellent { background: var(--green-bg); color: var(--green); }
  .rating-badge.good { background: rgba(59,130,246,0.15); color: var(--accent); }
  .rating-badge.fair { background: var(--yellow-bg); color: var(--yellow); }
  .rating-badge.poor { background: var(--red-bg); color: var(--red); }
  .rec-chip { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 6px; }
  .rec-chip.strong-buy, .rec-chip.buy { background: var(--green-bg); color: var(--green); }
  .rec-chip.hold { background: rgba(59,130,246,0.15); color: var(--accent); }
  .rec-chip.trim { background: var(--yellow-bg); color: var(--yellow); }
  .rec-chip.sell { background: var(--red-bg); color: var(--red); }
  .pos-reasoning { font-size: 11px; color: var(--text-secondary); margin-top: 6px; line-height: 1.4; font-style: italic; }

  /* Score Cards */
  .score-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .score-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; }
  .score-card .sc-value { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; margin-bottom: 4px; }
  .score-card .sc-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .score-card .sc-bar { height: 4px; background: var(--bg-primary); border-radius: 2px; margin-top: 10px; overflow: hidden; }
  .score-card .sc-bar-fill { height: 100%; border-radius: 2px; transition: width 0.8s ease; }

  /* Risk Factors */
  .risk-factors { display: grid; gap: 10px; margin-top: 20px; }
  .risk-factor { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 18px; display: flex; align-items: center; gap: 12px; }
  .risk-factor .severity { width: 4px; height: 36px; border-radius: 2px; flex-shrink: 0; }
  .risk-factor .severity.high { background: var(--red); }
  .risk-factor .severity.medium { background: var(--yellow); }
  .risk-factor .severity.low { background: var(--green); }
  .risk-factor .rf-title { font-size: 13px; font-weight: 500; }
  .risk-factor .rf-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

  /* Region Cards */
  .region-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 20px; }
  .region-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
  .region-card .rc-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
  .region-card .rc-pct { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; color: var(--accent); }
  .region-card .rc-value { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .region-card .rc-bar { height: 4px; background: var(--bg-primary); border-radius: 2px; margin-top: 10px; overflow: hidden; }
  .region-card .rc-bar-fill { height: 100%; border-radius: 2px; }

  /* Actions Cards (Small/Big Moves) */
  .actions-section { margin-top: 20px; }
  .actions-section h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .action-cards { display: grid; gap: 10px; }
  .action-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 18px; display: flex; align-items: flex-start; gap: 12px; }
  .action-card .action-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; font-weight: 700; }
  .action-card .action-icon.small { background: var(--green-bg); color: var(--green); }
  .action-card .action-icon.big { background: var(--purple-bg); color: var(--purple); }
  .action-card .action-title { font-size: 13px; font-weight: 500; }
  .action-card .action-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; line-height: 1.4; }
  .action-card .action-impact { font-size: 11px; font-weight: 600; margin-top: 4px; }

  /* AI Section */
  .analysis-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
  .analysis-header h2 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .analysis-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  .prompt-select { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; font-family: inherit; font-size: 13px; cursor: pointer; outline: none; }
  .prompt-select:focus { border-color: var(--accent); }
  .custom-prompt-area { display: none; margin-top: 12px; margin-bottom: 16px; }
  .custom-prompt-area.visible { display: block; }
  .custom-prompt-area textarea { width: 100%; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 14px; border-radius: 8px; font-family: inherit; font-size: 13px; line-height: 1.6; resize: vertical; min-height: 80px; outline: none; }
  .custom-prompt-area textarea:focus { border-color: var(--accent); }

  .ai-response { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; min-height: 200px; position: relative; overflow: hidden; max-height: 600px; overflow-y: auto; }
  .ai-response::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent), var(--purple), var(--accent)); background-size: 200% 100%; opacity: 0; transition: opacity 0.3s; }
  .ai-response.loading::before { opacity: 1; animation: shimmer 2s linear infinite; }
  @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  .ai-response .placeholder { color: var(--text-muted); text-align: center; padding: 60px 20px; font-size: 14px; }
  .ai-response::-webkit-scrollbar { width: 6px; }
  .ai-response::-webkit-scrollbar-track { background: transparent; }
  .ai-response::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* AI Content (improved readability) */
  .ai-content { font-size: 14px; line-height: 1.8; color: var(--text-secondary); }
  .ai-content h1, .ai-content h2, .ai-content h3 { color: var(--text-primary); margin-top: 20px; margin-bottom: 10px; font-weight: 600; }
  .ai-content h1 { font-size: 18px; }
  .ai-content h2 { font-size: 16px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 6px; }
  .ai-content h3 { font-size: 14px; color: var(--text-secondary); }
  .ai-content p { margin-bottom: 12px; color: var(--text-secondary); }
  .ai-content strong { color: var(--text-primary); font-weight: 600; }
  .ai-content em { color: var(--text-muted); }
  .ai-content ul, .ai-content ol { margin: 8px 0 16px 20px; }
  .ai-content li { margin-bottom: 6px; padding-left: 4px; }
  .ai-content li::marker { color: var(--accent); }
  .ai-content code { background: var(--bg-primary); padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--purple); }
  .ai-content hr { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
  .streaming-cursor::after { content: '\25CA'; color: var(--accent); animation: blink 0.8s step-end infinite; }
  @keyframes blink { 50% { opacity: 0; } }

  /* Spinner */
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Toast */
  .toast { position: fixed; bottom: 20px; right: 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 12px 18px; font-size: 13px; color: var(--text-primary); box-shadow: 0 8px 32px rgba(0,0,0,0.3); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 100; }
  .toast.visible { transform: translateY(0); opacity: 1; }
  .toast.error { border-color: var(--red); }
  .toast.success { border-color: var(--green); }

  /* Responsive */
  @media (max-width: 768px) {
    .charts-row { grid-template-columns: 1fr; }
    .holdings-grid { grid-template-columns: 1fr; }
    .score-banner { flex-direction: column; text-align: center; }
    .header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .analysis-header { flex-direction: column; align-items: flex-start; }
    .filter-bar { flex-direction: column; align-items: flex-start; }
    .risk-slider-wrap { margin-left: 0; }
    .holdings-controls { flex-direction: column; }
  }
  @media (max-width: 480px) {
    .summary-grid { grid-template-columns: 1fr 1fr; }
    .score-cards-grid { grid-template-columns: 1fr 1fr; }
    .tab-btn { padding: 8px 12px; font-size: 12px; }
  }
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo-mark">AI</div>
      <h1>Portfolio <span>Analyst</span></h1>
    </div>
    <div class="header-right">
      <div class="status-dot" id="statusDot" title="Not connected"></div>
      <button class="btn-settings" id="btnSettings" onclick="toggleSettings()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        API Key
      </button>
    </div>
  </div>

  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <label>Anthropic API Key</label>
    <div class="input-row">
      <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." autocomplete="off" />
      <button class="btn-primary" onclick="saveApiKey()">Save</button>
    </div>
    <div class="hint">
      Your key is stored in Wealthica's add-on data (tied to your account). Get a key from
      <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>.
      <br>API calls are billed to your Anthropic account. Each analysis uses ~2-3K tokens.
    </div>
  </div>

  <!-- Tab Navigation -->
  <nav class="tab-nav" id="tabNav">
    <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
    <button class="tab-btn" onclick="switchTab('holdings')">Holdings</button>
    <button class="tab-btn" onclick="switchTab('performance')">Performance</button>
    <button class="tab-btn" onclick="switchTab('risk')">Risk</button>
    <button class="tab-btn" onclick="switchTab('region')">Region</button>
    <button class="tab-btn" onclick="switchTab('ai')">AI Analyst</button>
  </nav>

  <!-- Filter Bar -->
  <div class="filter-bar" id="filterBar">
    <label>Account</label>
    <select id="accountFilter" onchange="applyAccountFilter()">
      <option value="all">All Accounts</option>
    </select>
    <div class="risk-slider-wrap">
      <label>Risk Tolerance</label>
      <input type="range" class="risk-slider" id="riskSlider" min="1" max="10" value="5" oninput="onRiskChange()">
      <span class="risk-level-label" id="riskLabel" style="color:var(--yellow)">Moderate</span>
    </div>
  </div>

  <!-- ==================== OVERVIEW TAB ==================== -->
  <section class="tab-panel active" id="panel-overview">
    <div class="score-banner" id="scoreBanner">
      <div class="score-ring">
        <svg width="100" height="100" viewBox="0 0 100 100">
          <circle class="ring-bg" cx="50" cy="50" r="42"/>
          <circle class="ring-fill" id="healthRingFill" cx="50" cy="50" r="42" stroke="var(--accent)" stroke-dasharray="263.89" stroke-dashoffset="263.89" transform="rotate(-90 50 50)"/>
          <text class="score-text" id="healthScoreText" x="50" y="50">--</text>
        </svg>
      </div>
      <div class="score-details">
        <h2>Portfolio Health Score</h2>
        <p id="healthSummary">Load your portfolio to see your health score and actionable insights.</p>
      </div>
    </div>

    <div class="summary-grid" id="summaryGrid">
      <div class="summary-card"><div class="label">Total Value</div><div class="value" id="totalValue">--</div><div class="sub" id="totalAccounts"></div></div>
      <div class="summary-card"><div class="label">Positions</div><div class="value" id="totalPositions">--</div><div class="sub" id="positionsSub"></div></div>
      <div class="summary-card"><div class="label">Total Gain/Loss</div><div class="value" id="totalGainLoss">--</div><div class="sub" id="gainLossPct"></div></div>
      <div class="summary-card"><div class="label">Top Holding</div><div class="value" id="topHolding" style="font-size:16px">--</div><div class="sub" id="topHoldingPct"></div></div>
    </div>

    <div class="charts-row">
      <div class="chart-card"><h3>Asset Allocation</h3><canvas id="allocationChart"></canvas></div>
      <div class="chart-card"><h3>Top Holdings</h3><canvas id="topHoldingsChart"></canvas></div>
    </div>

    <div class="accounts-grid" id="accountsGrid"></div>

    <!-- Small & Big Moves -->
    <div class="actions-section" id="smallMovesSection" style="display:none">
      <h3><span style="color:var(--green)">Quick Wins</span> — Small changes, meaningful impact</h3>
      <div class="action-cards" id="smallMoves"></div>
    </div>
    <div class="actions-section" id="bigMovesSection" style="display:none; margin-top:24px">
      <h3><span style="color:var(--purple)">Strategic Moves</span> — Bigger changes for long-term improvement</h3>
      <div class="action-cards" id="bigMoves"></div>
    </div>
  </section>

  <!-- ==================== HOLDINGS TAB ==================== -->
  <section class="tab-panel" id="panel-holdings">
    <div class="holdings-controls">
      <select id="holdingsSort" onchange="renderHoldingsTab()">
        <option value="value">Sort by Value</option>
        <option value="gainloss">Sort by Gain/Loss</option>
        <option value="return">Sort by Return %</option>
        <option value="weight">Sort by Weight</option>
        <option value="name">Sort by Name</option>
        <option value="rating">Sort by AI Rating</option>
      </select>
      <button class="btn-accent" id="btnRatePositions" onclick="ratePositions()">
        Get AI Position Ratings
      </button>
    </div>
    <div class="holdings-grid" id="holdingsGrid"></div>
    <div class="chart-card" style="margin-top:20px"><h3>Portfolio Weights</h3><canvas id="holdingsWeightChart"></canvas></div>
  </section>

  <!-- ==================== PERFORMANCE TAB ==================== -->
  <section class="tab-panel" id="panel-performance">
    <div class="summary-grid" id="perfSummaryGrid"></div>
    <div class="chart-card"><h3>Gain/Loss by Position</h3><canvas id="gainLossChart"></canvas></div>
    <div class="chart-card" style="margin-top:20px"><h3>Performance by Account</h3><canvas id="accountPerfChart"></canvas></div>
  </section>

  <!-- ==================== RISK TAB ==================== -->
  <section class="tab-panel" id="panel-risk">
    <div class="score-cards-grid" id="riskScoresGrid"></div>
    <div class="charts-row">
      <div class="chart-card"><h3>Concentration</h3><canvas id="concentrationChart"></canvas></div>
      <div class="chart-card"><h3>Position Weight Distribution</h3><canvas id="riskWeightsChart"></canvas></div>
    </div>
    <div class="risk-factors" id="riskFactors"></div>
  </section>

  <!-- ==================== REGION TAB ==================== -->
  <section class="tab-panel" id="panel-region">
    <div class="charts-row">
      <div class="chart-card"><h3>Geographic Allocation</h3><canvas id="geoChart"></canvas></div>
      <div class="chart-card"><h3>Currency Exposure</h3><canvas id="currencyChart"></canvas></div>
    </div>
    <div class="region-cards" id="regionCards"></div>
  </section>

  <!-- ==================== AI ANALYST TAB ==================== -->
  <section class="tab-panel" id="panel-ai">
    <div class="analysis-header">
      <h2>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
        AI Analysis
      </h2>
      <div class="analysis-actions">
        <select class="prompt-select" id="promptSelect" onchange="onPromptChange()">
          <option value="full">Full Analysis</option>
          <option value="risk">Concentration &amp; Risk</option>
          <option value="tax">Tax Optimization (Canadian)</option>
          <option value="rebalance">Rebalancing Suggestions</option>
          <option value="income">Income &amp; Dividends</option>
          <option value="custom">Custom Question...</option>
        </select>
        <button class="btn-primary" id="btnAnalyze" onclick="runAnalysis()" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          Analyze
        </button>
      </div>
    </div>
    <div class="custom-prompt-area" id="customPromptArea">
      <textarea id="customPrompt" placeholder="Ask anything about your portfolio... e.g. 'What is my exposure to US tech stocks?' or 'How should I rebalance for retirement in 20 years?'"></textarea>
    </div>
    <div class="ai-response" id="aiResponse">
      <div class="placeholder">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
        <br>Load your portfolio data, then click <strong>Analyze</strong> to get AI-powered insights.
      </div>
    </div>
  </section>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ─── State ───────────────────────────────────────────────────────────────────
let addon = null;
let apiKey = '';
let portfolioData = { positions: [], institutions: [], totalValue: 0, totalBook: 0 };
let filteredPositions = [];
let currentOptions = {};
let positionRatings = {};
let riskTolerance = 5;
let activeTab = 'overview';
const charts = {};

const CHART_COLORS = ['#3b82f6','#a855f7','#22c55e','#f59e0b','#ef4444','#06b6d4','#ec4899','#f97316','#14b8a6','#6366f1','#84cc16','#f43f5e'];

// ─── Prompt Templates ────────────────────────────────────────────────────────
const PROMPTS = {
  full: `You are a senior portfolio analyst. Analyze this Canadian investor's portfolio and provide:\n\n1. **Portfolio Overview** — Total value, number of positions, asset class breakdown\n2. **Concentration Risk** — Any single positions >10% of portfolio, sector concentration\n3. **Geographic Exposure** — Canadian vs US vs International allocation\n4. **Account Type Optimization** — Are holdings in the right account types (RRSP/TFSA/Non-reg) for tax efficiency?\n5. **Key Risks** — What are the top 3 risks in this portfolio?\n6. **Suggestions** — 3-5 actionable rebalancing suggestions\n\nUse CAD as the default currency. Be specific with numbers and percentages. Format with markdown headers and bullet points.`,
  risk: `You are a risk analyst. Analyze this portfolio for concentration and risk:\n\n1. **Single Stock Concentration** — Flag any position >5% of total portfolio\n2. **Sector Exposure** — Identify sector tilts vs broad market\n3. **Correlation Risk** — Which holdings are likely highly correlated?\n4. **Downside Scenarios** — What happens if the top 3 holdings drop 30%?\n5. **Diversification Score** — Rate the portfolio's diversification 1-10\n\nBe specific with dollar amounts and percentages. Use CAD.`,
  tax: `You are a Canadian tax optimization specialist. Analyze this portfolio for tax efficiency:\n\n1. **Account Placement** — Are US dividend payers in RRSP (withholding tax advantage)? Are growth stocks in TFSA?\n2. **Tax-Loss Harvesting** — Any positions with unrealized losses that could be harvested?\n3. **Capital Gains Exposure** — Large unrealized gains that may create future tax events?\n4. **TFSA Optimization** — Is the TFSA being used for highest-growth assets?\n5. **Recommendations** — Specific moves to improve after-tax returns\n\nReference Canadian tax rules. Be specific with numbers.`,
  rebalance: `You are a portfolio manager. Suggest specific rebalancing moves:\n\n1. **Current Allocation** — Break down by asset class, geography, and sector\n2. **Target vs Actual** — Assuming a balanced growth portfolio, what's over/underweight?\n3. **Specific Trades** — List exact positions to trim or add to\n4. **Priority Order** — Which changes have the highest impact?\n5. **Implementation** — Which accounts should each trade happen in?\n\nBe specific and actionable. Use CAD amounts.`,
  income: `You are a dividend and income analyst. Analyze this portfolio's income characteristics:\n\n1. **Estimated Annual Dividends** — By position and total\n2. **Yield Analysis** — Portfolio yield vs benchmark\n3. **Dividend Safety** — Any positions with at-risk dividends?\n4. **Growth vs Income** — Current balance and recommendations\n5. **Tax-Efficient Income** — Which account types hold which income producers?\n\nUse CAD. Be specific with dollar amounts.`,
};

// ─── Tab Management ──────────────────────────────────────────────────────────
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b => {
    if (b.textContent.toLowerCase().replace(/\s/g,'').includes(tab)) b.classList.add('active');
  });
  renderActiveTab();
}

function renderActiveTab() {
  if (filteredPositions.length === 0) return;
  switch(activeTab) {
    case 'overview': renderOverview(); break;
    case 'holdings': renderHoldingsTab(); break;
    case 'performance': renderPerformance(); break;
    case 'risk': renderRisk(); break;
    case 'region': renderRegion(); break;
  }
}

// ─── Risk Slider ─────────────────────────────────────────────────────────────
function onRiskChange() {
  riskTolerance = parseInt(document.getElementById('riskSlider').value);
  const label = document.getElementById('riskLabel');
  if (riskTolerance <= 3) { label.textContent = 'Conservative'; label.style.color = 'var(--green)'; }
  else if (riskTolerance <= 5) { label.textContent = 'Moderate'; label.style.color = 'var(--yellow)'; }
  else if (riskTolerance <= 7) { label.textContent = 'Growth'; label.style.color = 'var(--orange)'; }
  else { label.textContent = 'Aggressive'; label.style.color = 'var(--red)'; }
  generateMoves();
}

// ─── Initialize Add-on ──────────────────────────────────────────────────────
if (typeof Addon === 'undefined') {
  console.error('wealthica.js failed to load');
  showToast('Running in demo mode', 'error');
  loadDemoData();
} else {
  try {
    addon = new Addon();
    let initReceived = false;
    setTimeout(function() { if (!initReceived) showToast('Waiting for Wealthica...', 'error'); }, 10000);
    addon.on('init', function(options) {
      initReceived = true;
      currentOptions = options;
      if (options.data && options.data.apiKey) {
        apiKey = options.data.apiKey;
        document.getElementById('apiKeyInput').value = apiKey;
        updateStatus('connected', 'API key loaded');
      }
      loadPortfolio();
    });
    addon.on('reload', function() { loadPortfolio(); });
    addon.on('update', function(options) { currentOptions = { ...currentOptions, ...options }; loadPortfolio(); });
  } catch(e) {
    console.log('Not running inside Wealthica.', e);
    showToast('Demo mode — not inside Wealthica', 'error');
    loadDemoData();
  }
}

// ─── Portfolio Loading ───────────────────────────────────────────────────────
function buildQuery(options) {
  return {
    from: options.dateRangeFilter && options.dateRangeFilter[0],
    to: options.dateRangeFilter && options.dateRangeFilter[1],
    groups: options.groupsFilter,
    institutions: options.institutionsFilter,
    investments: options.investmentsFilter === 'all' ? null : options.investmentsFilter,
  };
}

async function loadPortfolio() {
  if (!addon) return;
  try {
    const query = buildQuery(currentOptions);
    const [positions, institutions] = await Promise.all([
      addon.api.getPositions(query),
      addon.api.getInstitutions(query),
    ]);
    portfolioData.positions = positions || [];
    portfolioData.institutions = institutions || [];
    processPortfolio();
    filteredPositions = [...portfolioData.positions];
    populateAccountFilter();
    renderAllTabs();
    document.getElementById('btnAnalyze').disabled = !apiKey;
    if (portfolioData.positions.length > 0) showToast('Loaded ' + portfolioData.positions.length + ' positions', 'success');
  } catch(err) {
    console.error('Failed to load portfolio:', err);
    showToast('Failed to load: ' + (err.message || err), 'error');
  }
}

function processPortfolio() {
  let totalValue = 0, totalBook = 0;
  const instMap = {};
  portfolioData.institutions.forEach(inst => {
    instMap[inst._id] = inst;
    if (inst.investments) inst.investments.forEach(inv => { instMap[inv._id] = { ...inst, accountName: inv.name || inst.name }; });
  });
  portfolioData.positions.forEach(pos => {
    const mv = pos.market_value || pos.value || 0;
    const bv = pos.book_value || mv;
    totalValue += mv;
    totalBook += bv;
    if (pos.investment && instMap[pos.investment]) pos._accountName = instMap[pos.investment].accountName || instMap[pos.investment].name;
    else if (pos.institution && instMap[pos.institution]) pos._accountName = instMap[pos.institution].name;
  });
  portfolioData.totalValue = totalValue;
  portfolioData.totalBook = totalBook;
}

// ─── Account Filter ──────────────────────────────────────────────────────────
function populateAccountFilter() {
  const sel = document.getElementById('accountFilter');
  const accounts = [...new Set(portfolioData.positions.map(p => p._accountName || 'Unknown'))].sort();
  sel.innerHTML = '<option value="all">All Accounts</option>';
  accounts.forEach(a => { const o = document.createElement('option'); o.value = a; o.textContent = a; sel.appendChild(o); });
}

function applyAccountFilter() {
  const val = document.getElementById('accountFilter').value;
  filteredPositions = val === 'all' ? [...portfolioData.positions] : portfolioData.positions.filter(p => (p._accountName || 'Unknown') === val);
  renderAllTabs();
}

function renderAllTabs() {
  renderSummary();
  renderAccounts();
  renderActiveTab();
  generateMoves();
}

// ─── Inference Functions ─────────────────────────────────────────────────────
function inferRegion(symbol) {
  if (!symbol) return 'Unknown';
  const s = symbol.toUpperCase();
  if (/\.(TO|TSX|V|VN|CN)$/i.test(s)) return 'Canada';
  if (['BTC','ETH','SOL','ADA','DOT','DOGE','XRP','LINK','AVAX','MATIC','USDT','USDC'].includes(s)) return 'Crypto';
  const intlETFs = ['XEF.TO','VIU.TO','XEC.TO','VEE.TO','ZEA.TO','VXUS','IXUS','EFA','EEM'];
  if (intlETFs.includes(s)) return 'International';
  if (/\.(L|LSE|PA|DE|AS|MI|MC|SW|HK|SS|SZ|T|AX)$/i.test(s)) return 'International';
  return 'United States';
}

function inferSector(symbol, name, type) {
  const s = (symbol || '').toUpperCase();
  const n = (name || '').toLowerCase();
  if (type === 'crypto' || ['BTC','ETH','SOL','ADA','DOT','DOGE','XRP'].includes(s)) return 'Crypto';
  if (['XEQT.TO','VEQT.TO','XGRO.TO','VGRO.TO','XBAL.TO','VBAL.TO','VT','VTI'].includes(s)) return 'Diversified';
  if (['VFV.TO','VSP.TO','SPY','VOO','IVV','ZSP.TO'].includes(s)) return 'US Equity';
  if (['XQQ.TO','QQQ','ZQQ.TO','TEC.TO','ARKK','XIT.TO'].includes(s) || n.includes('nasdaq') || n.includes('technology')) return 'Technology';
  if (['TD.TO','RY.TO','BMO.TO','BNS.TO','CM.TO','NA.TO','JPM','BAC','GS','ZEB.TO'].includes(s) || n.includes('bank') || n.includes('financial')) return 'Financials';
  if (['ENB.TO','TRP.TO','SU.TO','CNQ.TO','CVE.TO','XEG.TO','XLE'].includes(s) || n.includes('energy')) return 'Energy';
  if (n.includes('reit') || n.includes('real estate') || /\.UN\.TO$/.test(s)) return 'Real Estate';
  if (n.includes('bond') || n.includes('fixed') || ['XBB.TO','ZAG.TO','VAB.TO','BND','AGG'].includes(s)) return 'Fixed Income';
  if (n.includes('gold') || n.includes('mining') || ['GLD','IAU','XGD.TO','ABX.TO'].includes(s)) return 'Materials';
  if (n.includes('health') || ['XLV','ZUH.TO'].includes(s)) return 'Healthcare';
  return 'Other';
}

// ─── Scoring ─────────────────────────────────────────────────────────────────
function computeScores() {
  const positions = filteredPositions;
  const totalVal = positions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  if (!positions.length || !totalVal) return { health: 0, diversification: 0, risk: 50, performance: 50 };

  const weights = positions.map(p => (p.market_value || p.value || 0) / totalVal);
  const hhi = weights.reduce((s,w) => s + w*w, 0);
  const n = positions.length;
  const minHHI = n > 0 ? 1/n : 1;
  const divScore = Math.round(Math.min(100, Math.max(0, (1 - (hhi - minHHI) / (1 - minHHI)) * 100)));

  const maxW = Math.max(...weights) * 100;
  const top3W = [...weights].sort((a,b)=>b-a).slice(0,3).reduce((s,w)=>s+w,0) * 100;
  const concRisk = Math.round(maxW * 0.5 + Math.max(0, top3W - 60) * 0.5);
  const riskScore = Math.max(0, Math.min(100, 100 - concRisk));

  const totalBook = positions.reduce((s,p) => s + (p.book_value || p.market_value || p.value || 0), 0);
  const totalReturn = totalBook > 0 ? ((totalVal - totalBook) / totalBook) * 100 : 0;
  const perfScore = Math.max(0, Math.min(100, 50 + totalReturn * 2));

  const countScore = Math.min(100, new Set(positions.map(p => p.security?.symbol || p.symbol)).size * 12);
  const health = Math.round(divScore * 0.3 + riskScore * 0.25 + perfScore * 0.25 + countScore * 0.2);

  return { health, diversification: divScore, risk: riskScore, performance: Math.round(perfScore), maxConcentration: maxW, top3Concentration: top3W, totalReturn, hhi };
}

function scoreColor(score) {
  if (score >= 70) return 'var(--green)';
  if (score >= 40) return 'var(--yellow)';
  return 'var(--red)';
}

// ─── Rendering Helpers ───────────────────────────────────────────────────────
function fmt(n, decimals) {
  if (decimals === undefined) decimals = 0;
  if (n === undefined || n === null || isNaN(n)) return '--';
  return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(n);
}
function pct(n) { if (!n || isNaN(n)) return ''; return (n >= 0 ? '+' : '') + n.toFixed(2) + '%'; }
function escapeHtml(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

function makeChart(key, ctx, config) {
  if (charts[key]) charts[key].destroy();
  charts[key] = new Chart(ctx, config);
}

// ─── Overview Rendering ──────────────────────────────────────────────────────
function renderSummary() {
  const totalValue = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const totalBook = filteredPositions.reduce((s,p) => s + (p.book_value || p.market_value || p.value || 0), 0);
  const gainLoss = totalValue - totalBook;
  const gainLossPctVal = totalBook > 0 ? ((totalValue - totalBook) / totalBook) * 100 : 0;
  const accounts = [...new Set(filteredPositions.map(p => p._accountName).filter(Boolean))];

  document.getElementById('totalValue').textContent = fmt(totalValue);
  document.getElementById('totalAccounts').textContent = accounts.length + ' account' + (accounts.length !== 1 ? 's' : '');
  document.getElementById('totalPositions').textContent = filteredPositions.length;
  const uniq = new Set(filteredPositions.map(p => p.security?.symbol || p.symbol).filter(Boolean));
  document.getElementById('positionsSub').textContent = uniq.size + ' unique securities';
  const glEl = document.getElementById('totalGainLoss');
  glEl.textContent = fmt(gainLoss);
  glEl.className = 'value ' + (gainLoss >= 0 ? 'positive' : 'negative');
  document.getElementById('gainLossPct').textContent = pct(gainLossPctVal);
  document.getElementById('gainLossPct').className = 'sub ' + (gainLoss >= 0 ? 'positive' : 'negative');

  if (filteredPositions.length > 0) {
    const sorted = [...filteredPositions].sort((a,b) => (b.market_value||b.value||0) - (a.market_value||a.value||0));
    const top = sorted[0];
    document.getElementById('topHolding').textContent = top.security?.symbol || top.symbol || 'N/A';
    document.getElementById('topHoldingPct').textContent = (((top.market_value||top.value||0)/totalValue)*100).toFixed(1) + '% of portfolio';
  }

  // Health score
  const scores = computeScores();
  const circ = 2 * Math.PI * 42;
  const ring = document.getElementById('healthRingFill');
  ring.style.strokeDasharray = circ;
  ring.style.strokeDashoffset = circ * (1 - scores.health / 100);
  ring.style.stroke = scoreColor(scores.health);
  document.getElementById('healthScoreText').textContent = scores.health;
  const summaries = [];
  if (scores.diversification >= 70) summaries.push('Well diversified');
  else if (scores.diversification >= 40) summaries.push('Moderate diversification');
  else summaries.push('Low diversification — consider spreading holdings');
  if (scores.totalReturn > 10) summaries.push('Strong returns of ' + pct(scores.totalReturn));
  else if (scores.totalReturn > 0) summaries.push('Positive returns of ' + pct(scores.totalReturn));
  else if (scores.totalReturn < 0) summaries.push('Negative returns of ' + pct(scores.totalReturn));
  if (scores.maxConcentration > 30) summaries.push('High concentration: top position is ' + scores.maxConcentration.toFixed(1) + '%');
  document.getElementById('healthSummary').textContent = summaries.join('. ') + '.';
}

function renderOverview() {
  const totalValue = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);

  // Allocation chart (by type/sector)
  const sectorMap = {};
  filteredPositions.forEach(p => {
    const sector = inferSector(p.security?.symbol || p.symbol, p.security?.name, p.security?.type);
    sectorMap[sector] = (sectorMap[sector] || 0) + (p.market_value || p.value || 0);
  });
  const sectorEntries = Object.entries(sectorMap).sort((a,b) => b[1] - a[1]);
  makeChart('allocation', document.getElementById('allocationChart'), {
    type: 'doughnut',
    data: { labels: sectorEntries.map(e=>e[0]), datasets: [{ data: sectorEntries.map(e=>e[1]), backgroundColor: CHART_COLORS.slice(0, sectorEntries.length), borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: true, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { padding: 10, usePointStyle: true, pointStyleWidth: 8, font: { size: 11 } } } } }
  });

  // Top holdings bar chart
  const sorted = [...filteredPositions].sort((a,b) => (b.market_value||b.value||0) - (a.market_value||a.value||0)).slice(0, 8);
  makeChart('topHoldings', document.getElementById('topHoldingsChart'), {
    type: 'bar',
    data: {
      labels: sorted.map(p => p.security?.symbol || p.symbol || '?'),
      datasets: [{ data: sorted.map(p => p.market_value || p.value || 0), backgroundColor: '#3b82f6', borderRadius: 4 }]
    },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(42,53,80,0.3)' }, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } }, y: { grid: { display: false } } } }
  });
}

function renderAccounts() {
  const grid = document.getElementById('accountsGrid');
  grid.innerHTML = '';
  const acctValues = {};
  filteredPositions.forEach(pos => {
    const name = pos._accountName || 'Unknown';
    acctValues[name] = (acctValues[name] || 0) + (pos.market_value || pos.value || 0);
  });
  Object.entries(acctValues).sort((a,b) => b[1] - a[1]).forEach(([name, value]) => {
    const chip = document.createElement('div');
    chip.className = 'account-chip';
    chip.innerHTML = '<div class="acct-name">' + escapeHtml(name) + '</div><div class="acct-value">' + fmt(value) + '</div>';
    grid.appendChild(chip);
  });
}

// ─── Holdings Tab ────────────────────────────────────────────────────────────
function renderHoldingsTab() {
  const totalVal = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const sortBy = document.getElementById('holdingsSort').value;

  let sorted = [...filteredPositions];
  switch(sortBy) {
    case 'value': sorted.sort((a,b) => (b.market_value||b.value||0) - (a.market_value||a.value||0)); break;
    case 'gainloss': sorted.sort((a,b) => ((b.market_value||b.value||0)-(b.book_value||0)) - ((a.market_value||a.value||0)-(a.book_value||0))); break;
    case 'return': sorted.sort((a,b) => { const ra = a.book_value ? ((a.market_value||a.value||0)-a.book_value)/a.book_value : 0; const rb = b.book_value ? ((b.market_value||b.value||0)-b.book_value)/b.book_value : 0; return rb - ra; }); break;
    case 'weight': sorted.sort((a,b) => (b.market_value||b.value||0) - (a.market_value||a.value||0)); break;
    case 'name': sorted.sort((a,b) => ((a.security?.symbol||a.symbol||'') ).localeCompare(b.security?.symbol||b.symbol||'')); break;
    case 'rating': sorted.sort((a,b) => (positionRatings[b.security?.symbol||b.symbol]?.score||0) - (positionRatings[a.security?.symbol||a.symbol]?.score||0)); break;
  }

  const grid = document.getElementById('holdingsGrid');
  grid.innerHTML = '';

  sorted.forEach(pos => {
    const sym = pos.security?.symbol || pos.symbol || '--';
    const name = pos.security?.name || '';
    const mv = pos.market_value || pos.value || 0;
    const bv = pos.book_value || mv;
    const gl = mv - bv;
    const ret = bv > 0 ? ((mv - bv)/bv)*100 : 0;
    const weight = totalVal > 0 ? (mv/totalVal)*100 : 0;
    const rating = positionRatings[sym];

    const card = document.createElement('div');
    card.className = 'position-card';
    let ratingHTML = '';
    if (rating) {
      const rClass = rating.score >= 8 ? 'excellent' : rating.score >= 6 ? 'good' : rating.score >= 4 ? 'fair' : 'poor';
      const recClass = (rating.recommendation || '').toLowerCase().replace(/\s+/g, '-');
      ratingHTML = '<div class="rating-badge ' + rClass + '">' + rating.score + '</div>';
      ratingHTML += '<div><span class="rec-chip ' + recClass + '">' + escapeHtml(rating.recommendation || '') + '</span></div>';
      if (rating.reasoning) ratingHTML += '<div class="pos-reasoning">"' + escapeHtml(rating.reasoning) + '"</div>';
    }

    card.innerHTML = '<div class="pos-header"><div><div class="pos-symbol">' + escapeHtml(sym) + '</div>' +
      (name ? '<div class="pos-name">' + escapeHtml(name) + '</div>' : '') +
      '<div class="pos-account">' + escapeHtml(pos._accountName || '--') + '</div></div>' +
      (rating ? '<div style="text-align:right">' + ratingHTML + '</div>' : '') +
      '</div><div class="pos-values">' +
      '<div class="pos-metric"><div class="pm-label">Value</div><div class="pm-value">' + fmt(mv) + '</div></div>' +
      '<div class="pos-metric"><div class="pm-label">Gain/Loss</div><div class="pm-value ' + (gl>=0?'positive':'negative') + '">' + fmt(gl) + ' (' + pct(ret) + ')</div></div>' +
      '<div class="pos-metric"><div class="pm-label">Quantity</div><div class="pm-value">' + (pos.quantity != null ? Number(pos.quantity).toLocaleString('en-CA',{maximumFractionDigits:4}) : '--') + '</div></div>' +
      '<div class="pos-metric"><div class="pm-label">Book Value</div><div class="pm-value">' + fmt(bv) + '</div></div>' +
      '</div><div class="pos-weight-bar"><div class="pos-weight-fill" style="width:' + Math.min(100,weight) + '%"></div></div>' +
      '<div class="pos-weight-label">' + weight.toFixed(1) + '% of portfolio</div>';
    grid.appendChild(card);
  });

  // Weight chart
  const topN = sorted.slice(0, 12);
  makeChart('holdingsWeight', document.getElementById('holdingsWeightChart'), {
    type: 'bar',
    data: {
      labels: topN.map(p => p.security?.symbol || p.symbol || '?'),
      datasets: [{ label: 'Weight %', data: topN.map(p => totalVal > 0 ? ((p.market_value||p.value||0)/totalVal*100) : 0), backgroundColor: CHART_COLORS.slice(0, topN.length), borderRadius: 4 }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(42,53,80,0.3)' }, ticks: { callback: v => v + '%' } }, x: { grid: { display: false } } } }
  });
}

// ─── Performance Tab ─────────────────────────────────────────────────────────
function renderPerformance() {
  const totalVal = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const totalBook = filteredPositions.reduce((s,p) => s + (p.book_value || p.market_value || p.value || 0), 0);
  const totalGL = totalVal - totalBook;
  const totalRet = totalBook > 0 ? ((totalVal - totalBook) / totalBook) * 100 : 0;

  // Best/worst
  const withReturn = filteredPositions.map(p => {
    const mv = p.market_value || p.value || 0;
    const bv = p.book_value || mv;
    return { ...p, ret: bv > 0 ? ((mv-bv)/bv)*100 : 0, gl: mv - bv };
  }).sort((a,b) => b.ret - a.ret);
  const best = withReturn[0];
  const worst = withReturn[withReturn.length - 1];

  const grid = document.getElementById('perfSummaryGrid');
  grid.innerHTML = '';
  const cards = [
    { label: 'Total Return', value: pct(totalRet), cls: totalRet >= 0 ? 'positive' : 'negative', sub: fmt(totalGL) },
    { label: 'Best Performer', value: best ? (best.security?.symbol || best.symbol || '--') : '--', cls: 'positive', sub: best ? pct(best.ret) : '' },
    { label: 'Worst Performer', value: worst ? (worst.security?.symbol || worst.symbol || '--') : '--', cls: worst && worst.ret < 0 ? 'negative' : '', sub: worst ? pct(worst.ret) : '' },
    { label: 'Avg Return', value: pct(withReturn.length > 0 ? withReturn.reduce((s,p)=>s+p.ret,0)/withReturn.length : 0), cls: '', sub: filteredPositions.length + ' positions' },
  ];
  cards.forEach(c => {
    const d = document.createElement('div');
    d.className = 'summary-card';
    d.innerHTML = '<div class="label">' + c.label + '</div><div class="value ' + c.cls + '" style="font-size:16px">' + c.value + '</div><div class="sub">' + c.sub + '</div>';
    grid.appendChild(d);
  });

  // Gain/loss by position
  const glSorted = [...withReturn].sort((a,b) => b.gl - a.gl);
  makeChart('gainLoss', document.getElementById('gainLossChart'), {
    type: 'bar',
    data: {
      labels: glSorted.map(p => p.security?.symbol || p.symbol || '?'),
      datasets: [{ data: glSorted.map(p => p.gl), backgroundColor: glSorted.map(p => p.gl >= 0 ? '#22c55e' : '#ef4444'), borderRadius: 4 }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(42,53,80,0.3)' }, ticks: { callback: v => '$' + (v/1000).toFixed(1) + 'k' } }, x: { grid: { display: false } } } }
  });

  // By account
  const acctPerf = {};
  filteredPositions.forEach(p => {
    const a = p._accountName || 'Unknown';
    if (!acctPerf[a]) acctPerf[a] = { mv: 0, bv: 0 };
    acctPerf[a].mv += (p.market_value || p.value || 0);
    acctPerf[a].bv += (p.book_value || p.market_value || p.value || 0);
  });
  const acctEntries = Object.entries(acctPerf).sort((a,b) => (b[1].mv-b[1].bv) - (a[1].mv-a[1].bv));
  makeChart('accountPerf', document.getElementById('accountPerfChart'), {
    type: 'bar',
    data: {
      labels: acctEntries.map(e => e[0]),
      datasets: [
        { label: 'Book Value', data: acctEntries.map(e => e[1].bv), backgroundColor: 'rgba(59,130,246,0.3)', borderRadius: 4 },
        { label: 'Market Value', data: acctEntries.map(e => e[1].mv), backgroundColor: '#3b82f6', borderRadius: 4 },
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, pointStyleWidth: 8 } } }, scales: { y: { grid: { color: 'rgba(42,53,80,0.3)' }, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' } }, x: { grid: { display: false } } } }
  });
}

// ─── Risk Tab ────────────────────────────────────────────────────────────────
function renderRisk() {
  const scores = computeScores();
  const grid = document.getElementById('riskScoresGrid');
  grid.innerHTML = '';
  [
    { label: 'Diversification', value: scores.diversification, color: scoreColor(scores.diversification) },
    { label: 'Concentration Safety', value: scores.risk, color: scoreColor(scores.risk) },
    { label: 'Performance', value: scores.performance, color: scoreColor(scores.performance) },
    { label: 'Overall Health', value: scores.health, color: scoreColor(scores.health) },
  ].forEach(s => {
    const d = document.createElement('div');
    d.className = 'score-card';
    d.innerHTML = '<div class="sc-value" style="color:' + s.color + '">' + s.value + '</div><div class="sc-label">' + s.label + '</div><div class="sc-bar"><div class="sc-bar-fill" style="width:' + s.value + '%;background:' + s.color + '"></div></div>';
    grid.appendChild(d);
  });

  // Concentration chart
  const totalVal = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const sorted = [...filteredPositions].sort((a,b) => (b.market_value||b.value||0) - (a.market_value||a.value||0));
  const top5 = sorted.slice(0, 5);
  const rest = sorted.slice(5);
  const restVal = rest.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const concLabels = top5.map(p => p.security?.symbol || p.symbol || '?');
  const concData = top5.map(p => p.market_value || p.value || 0);
  if (restVal > 0) { concLabels.push('Others (' + rest.length + ')'); concData.push(restVal); }
  makeChart('concentration', document.getElementById('concentrationChart'), {
    type: 'doughnut',
    data: { labels: concLabels, datasets: [{ data: concData, backgroundColor: CHART_COLORS.slice(0, concLabels.length), borderWidth: 0 }] },
    options: { responsive: true, cutout: '55%', plugins: { legend: { position: 'bottom', labels: { padding: 8, usePointStyle: true, pointStyleWidth: 8, font: { size: 11 } } } } }
  });

  // Weight distribution
  const weights = sorted.map(p => ({ sym: p.security?.symbol || p.symbol || '?', w: totalVal > 0 ? (p.market_value||p.value||0)/totalVal*100 : 0 }));
  makeChart('riskWeights', document.getElementById('riskWeightsChart'), {
    type: 'bar',
    data: { labels: weights.map(w=>w.sym), datasets: [{ data: weights.map(w=>w.w), backgroundColor: weights.map(w => w.w > 20 ? '#ef4444' : w.w > 10 ? '#f59e0b' : '#3b82f6'), borderRadius: 4 }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(42,53,80,0.3)' }, ticks: { callback: v => v + '%' } }, x: { grid: { display: false } } } }
  });

  // Risk factors
  const factors = [];
  if (scores.maxConcentration > 25) factors.push({ severity: 'high', title: 'High Single Position Concentration', desc: 'Your largest position is ' + scores.maxConcentration.toFixed(1) + '% of portfolio. Consider trimming to below 20%.' });
  else if (scores.maxConcentration > 15) factors.push({ severity: 'medium', title: 'Moderate Concentration', desc: 'Largest position is ' + scores.maxConcentration.toFixed(1) + '% — within acceptable range but monitor closely.' });
  if (scores.top3Concentration > 70) factors.push({ severity: 'high', title: 'Top 3 Holdings Dominate', desc: 'Top 3 positions represent ' + scores.top3Concentration.toFixed(1) + '% of your portfolio.' });
  if (filteredPositions.length < 5) factors.push({ severity: 'high', title: 'Too Few Positions', desc: 'Only ' + filteredPositions.length + ' positions. Consider adding more for diversification.' });
  else if (filteredPositions.length < 10) factors.push({ severity: 'medium', title: 'Limited Positions', desc: filteredPositions.length + ' positions. Adequate but more diversification could help.' });

  const sectorMap = {};
  filteredPositions.forEach(p => {
    const sec = inferSector(p.security?.symbol||p.symbol, p.security?.name, p.security?.type);
    sectorMap[sec] = (sectorMap[sec]||0) + (p.market_value||p.value||0);
  });
  Object.entries(sectorMap).forEach(([sec, val]) => {
    const pctVal = totalVal > 0 ? val/totalVal*100 : 0;
    if (pctVal > 40) factors.push({ severity: 'high', title: sec + ' Overweight', desc: sec + ' is ' + pctVal.toFixed(1) + '% of portfolio — heavy sector bet.' });
    else if (pctVal > 25) factors.push({ severity: 'medium', title: sec + ' Tilt', desc: sec + ' at ' + pctVal.toFixed(1) + '% — notable sector exposure.' });
  });

  const regionMap = {};
  filteredPositions.forEach(p => {
    const r = inferRegion(p.security?.symbol || p.symbol);
    regionMap[r] = (regionMap[r]||0) + (p.market_value||p.value||0);
  });
  Object.entries(regionMap).forEach(([reg, val]) => {
    const pctVal = totalVal > 0 ? val/totalVal*100 : 0;
    if (pctVal > 60) factors.push({ severity: 'medium', title: reg + ' Heavy', desc: pctVal.toFixed(1) + '% in ' + reg + ' — consider international diversification.' });
  });

  if (factors.length === 0) factors.push({ severity: 'low', title: 'No Major Risks Detected', desc: 'Your portfolio appears well-balanced. Keep monitoring as markets change.' });

  const rfDiv = document.getElementById('riskFactors');
  rfDiv.innerHTML = '';
  factors.forEach(f => {
    const d = document.createElement('div');
    d.className = 'risk-factor';
    d.innerHTML = '<div class="severity ' + f.severity + '"></div><div><div class="rf-title">' + escapeHtml(f.title) + '</div><div class="rf-desc">' + escapeHtml(f.desc) + '</div></div>';
    rfDiv.appendChild(d);
  });
}

// ─── Region Tab ──────────────────────────────────────────────────────────────
function renderRegion() {
  const totalVal = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const regionMap = {}, currencyMap = {};
  filteredPositions.forEach(p => {
    const r = inferRegion(p.security?.symbol || p.symbol);
    regionMap[r] = (regionMap[r]||0) + (p.market_value||p.value||0);
    const c = p.security?.currency || p.currency || 'CAD';
    currencyMap[c] = (currencyMap[c]||0) + (p.market_value||p.value||0);
  });

  const regionEntries = Object.entries(regionMap).sort((a,b) => b[1] - a[1]);
  const regionColors = { 'Canada': '#ef4444', 'United States': '#3b82f6', 'International': '#22c55e', 'Crypto': '#f59e0b', 'Unknown': '#64748b' };
  makeChart('geo', document.getElementById('geoChart'), {
    type: 'doughnut',
    data: { labels: regionEntries.map(e=>e[0]), datasets: [{ data: regionEntries.map(e=>e[1]), backgroundColor: regionEntries.map(e => regionColors[e[0]] || '#6366f1'), borderWidth: 0 }] },
    options: { responsive: true, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { padding: 10, usePointStyle: true, pointStyleWidth: 8 } } } }
  });

  const currEntries = Object.entries(currencyMap).sort((a,b) => b[1] - a[1]);
  makeChart('currency', document.getElementById('currencyChart'), {
    type: 'doughnut',
    data: { labels: currEntries.map(e=>e[0]), datasets: [{ data: currEntries.map(e=>e[1]), backgroundColor: ['#3b82f6','#22c55e','#f59e0b','#ef4444','#a855f7'], borderWidth: 0 }] },
    options: { responsive: true, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { padding: 10, usePointStyle: true, pointStyleWidth: 8 } } } }
  });

  const regionDiv = document.getElementById('regionCards');
  regionDiv.innerHTML = '';
  regionEntries.forEach(([name, value]) => {
    const pctVal = totalVal > 0 ? (value/totalVal*100) : 0;
    const posCount = filteredPositions.filter(p => inferRegion(p.security?.symbol||p.symbol) === name).length;
    const d = document.createElement('div');
    d.className = 'region-card';
    d.innerHTML = '<div class="rc-name">' + escapeHtml(name) + '</div><div class="rc-pct">' + pctVal.toFixed(1) + '%</div><div class="rc-value">' + fmt(value) + ' · ' + posCount + ' position' + (posCount!==1?'s':'') + '</div><div class="rc-bar"><div class="rc-bar-fill" style="width:' + pctVal + '%;background:' + (regionColors[name]||'#6366f1') + '"></div></div>';
    regionDiv.appendChild(d);
  });
}

// ─── Small & Big Moves Generator ─────────────────────────────────────────────
function generateMoves() {
  const totalVal = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  if (!totalVal || filteredPositions.length === 0) return;
  const scores = computeScores();
  const smallMoves = [], bigMoves = [];

  // Analyze positions
  const sorted = [...filteredPositions].sort((a,b) => (b.market_value||b.value||0) - (a.market_value||a.value||0));
  const weights = sorted.map(p => ({ sym: p.security?.symbol||p.symbol||'?', w: (p.market_value||p.value||0)/totalVal*100, mv: p.market_value||p.value||0, bv: p.book_value||0, name: p.security?.name||'' }));

  // Small moves based on risk tolerance
  const maxAcceptable = riskTolerance <= 3 ? 10 : riskTolerance <= 5 ? 15 : riskTolerance <= 7 ? 25 : 35;
  weights.forEach(w => {
    if (w.w > maxAcceptable) {
      const trimAmt = w.mv * (1 - maxAcceptable / w.w);
      smallMoves.push({ title: 'Trim ' + w.sym, desc: 'Currently ' + w.w.toFixed(1) + '% of portfolio (max ' + maxAcceptable + '% for your risk level). Trim ~' + fmt(trimAmt) + '.', impact: 'Reduces concentration risk', color: 'var(--yellow)' });
    }
  });

  // Losses for tax-loss harvesting
  const losses = sorted.filter(p => (p.book_value||0) > (p.market_value||p.value||0)).map(p => ({ sym: p.security?.symbol||p.symbol, loss: (p.market_value||p.value||0) - p.book_value, acct: p._accountName||'' }));
  losses.filter(l => !l.acct.includes('TFSA') && !l.acct.includes('RRSP')).forEach(l => {
    smallMoves.push({ title: 'Tax-loss harvest ' + l.sym, desc: 'Unrealized loss of ' + fmt(l.loss) + ' in taxable account. Sell and re-buy similar ETF after 30 days.', impact: 'Potential tax savings of ' + fmt(Math.abs(l.loss) * 0.25), color: 'var(--green)' });
  });

  // Big moves
  const regionMap = {};
  filteredPositions.forEach(p => {
    const r = inferRegion(p.security?.symbol || p.symbol);
    regionMap[r] = (regionMap[r]||0) + (p.market_value||p.value||0);
  });
  Object.entries(regionMap).forEach(([r, v]) => {
    const pctVal = v/totalVal*100;
    if (r === 'Canada' && pctVal > 50) bigMoves.push({ title: 'Reduce Canadian home bias', desc: 'Canada is ' + pctVal.toFixed(1) + '% of your portfolio but represents <4% of global market cap. Add international diversification.', impact: 'Better global diversification' });
    if (r === 'United States' && pctVal > 70) bigMoves.push({ title: 'Add international exposure', desc: 'US-heavy at ' + pctVal.toFixed(1) + '%. Consider emerging markets or developed international ETFs.', impact: 'Broader geographic coverage' });
  });

  if (filteredPositions.length < 8 && riskTolerance <= 5) bigMoves.push({ title: 'Increase diversification', desc: 'Only ' + filteredPositions.length + ' positions. Consider all-in-one ETFs like XEQT or VGRO for instant diversification.', impact: 'Reduces single-stock risk significantly' });

  const sectorMap = {};
  filteredPositions.forEach(p => { const s = inferSector(p.security?.symbol||p.symbol, p.security?.name, p.security?.type); sectorMap[s] = (sectorMap[s]||0) + (p.market_value||p.value||0); });
  const hasBonds = sectorMap['Fixed Income'] || 0;
  if (riskTolerance <= 4 && hasBonds/totalVal < 0.1) bigMoves.push({ title: 'Add fixed income allocation', desc: 'Conservative risk profile but less than 10% in bonds. Consider bond ETFs like XBB.TO or ZAG.TO.', impact: 'Reduces portfolio volatility' });
  if (riskTolerance >= 7 && hasBonds/totalVal > 0.3) bigMoves.push({ title: 'Reduce bond allocation', desc: 'Aggressive risk profile but ' + ((hasBonds/totalVal)*100).toFixed(0) + '% in bonds. May be limiting growth potential.', impact: 'Higher expected returns' });

  if (smallMoves.length === 0) smallMoves.push({ title: 'Portfolio looks well-tuned', desc: 'No immediate small adjustments needed at your current risk level.', impact: 'Keep monitoring', color: 'var(--green)' });
  if (bigMoves.length === 0) bigMoves.push({ title: 'No major restructuring needed', desc: 'Your portfolio structure aligns well with your risk tolerance.', impact: 'Stay the course', color: 'var(--green)' });

  renderMoves('smallMoves', 'smallMovesSection', smallMoves, 'small');
  renderMoves('bigMoves', 'bigMovesSection', bigMoves, 'big');
}

function renderMoves(containerId, sectionId, moves, type) {
  document.getElementById(sectionId).style.display = 'block';
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  moves.forEach(m => {
    const d = document.createElement('div');
    d.className = 'action-card';
    d.innerHTML = '<div class="action-icon ' + type + '">' + (type === 'small' ? 'S' : 'B') + '</div><div><div class="action-title">' + escapeHtml(m.title) + '</div><div class="action-desc">' + escapeHtml(m.desc) + '</div><div class="action-impact" style="color:' + (m.color || (type==='small'?'var(--green)':'var(--purple)')) + '">' + escapeHtml(m.impact) + '</div></div>';
    container.appendChild(d);
  });
}

// ─── AI Position Ratings ─────────────────────────────────────────────────────
async function ratePositions() {
  if (!apiKey) { showToast('Set your API key first', 'error'); toggleSettings(); return; }
  if (filteredPositions.length === 0) { showToast('No positions to rate', 'error'); return; }

  const btn = document.getElementById('btnRatePositions');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Rating positions...';

  const totalVal = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const positionList = filteredPositions.map(p => {
    const mv = p.market_value || p.value || 0;
    const bv = p.book_value || mv;
    return {
      symbol: p.security?.symbol || p.symbol || 'N/A',
      name: p.security?.name || '',
      market_value: Math.round(mv*100)/100,
      book_value: Math.round(bv*100)/100,
      weight_pct: totalVal > 0 ? Math.round(mv/totalVal*10000)/100 : 0,
      return_pct: bv > 0 ? Math.round((mv-bv)/bv*10000)/100 : 0,
      account: p._accountName || 'Unknown',
      type: p.security?.type || '',
      currency: p.security?.currency || p.currency || 'CAD',
    };
  });

  const riskLabel = riskTolerance <= 3 ? 'conservative' : riskTolerance <= 5 ? 'moderate' : riskTolerance <= 7 ? 'growth' : 'aggressive';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4096,
        system: 'You are a senior portfolio analyst rating positions for a Canadian investor with a ' + riskLabel + ' risk profile (risk tolerance ' + riskTolerance + '/10). Rate each position 1-10 based on quality, portfolio fit, sizing, and suitability for their risk profile. Respond with ONLY valid JSON, no markdown, no explanation outside JSON.',
        messages: [{ role: 'user', content: 'Rate each position:\n\n' + JSON.stringify(positionList, null, 2) + '\n\nRespond with ONLY this JSON format:\n{"positions":[{"symbol":"...","score":8,"recommendation":"Hold","reasoning":"one sentence"}],"portfolio_score":72,"summary":"2-3 sentence assessment"}\n\nRecommendation must be: "Strong Buy", "Buy", "Hold", "Trim", or "Sell".\nScores: 1-3=Poor, 4-5=Below Avg, 6-7=Good, 8-9=Very Good, 10=Excellent.' }],
      }),
    });

    if (!response.ok) { const err = await response.json().catch(()=>({})); throw new Error(err.error?.message || 'API error: ' + response.status); }
    const data = await response.json();
    const text = data.content?.[0]?.text || '';

    try {
      const parsed = JSON.parse(text.replace(/```json\n?/g,'').replace(/```/g,'').trim());
      if (parsed.positions) {
        parsed.positions.forEach(p => { positionRatings[p.symbol] = p; });
        if (parsed.portfolio_score) {
          const scores = computeScores();
          document.getElementById('healthScoreText').textContent = parsed.portfolio_score;
          const circ = 2 * Math.PI * 42;
          const ring = document.getElementById('healthRingFill');
          ring.style.strokeDashoffset = circ * (1 - parsed.portfolio_score / 100);
          ring.style.stroke = scoreColor(parsed.portfolio_score);
        }
        if (parsed.summary) document.getElementById('healthSummary').textContent = parsed.summary;
        renderHoldingsTab();
        showToast('Rated ' + parsed.positions.length + ' positions', 'success');
      }
    } catch(parseErr) {
      console.error('Failed to parse AI ratings:', parseErr, text);
      showToast('AI returned invalid format. Try again.', 'error');
    }
  } catch(err) {
    console.error('Rating error:', err);
    showToast('Rating failed: ' + err.message, 'error');
  }

  btn.disabled = false;
  btn.innerHTML = 'Get AI Position Ratings';
}

// ─── AI Analysis ─────────────────────────────────────────────────────────────
async function runAnalysis() {
  if (!apiKey) { showToast('Set your API key first', 'error'); toggleSettings(); return; }
  if (filteredPositions.length === 0) { showToast('No portfolio data', 'error'); return; }

  const btn = document.getElementById('btnAnalyze');
  const responseEl = document.getElementById('aiResponse');
  const promptType = document.getElementById('promptSelect').value;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Analyzing...';
  responseEl.classList.add('loading');
  responseEl.innerHTML = '<div class="ai-content streaming-cursor"></div>';

  const portfolioSummary = buildPortfolioSummary();
  let systemPrompt = PROMPTS[promptType];
  if (promptType === 'custom') {
    const customQ = document.getElementById('customPrompt').value.trim();
    if (!customQ) { showToast('Enter a question', 'error'); resetAnalyzeBtn(); return; }
    systemPrompt = 'You are a senior portfolio analyst helping a Canadian investor. Answer their specific question. Be specific with numbers, percentages, and actionable advice. Use CAD. Format with markdown.';
    portfolioSummary.customQuestion = customQ;
  }

  const riskLabel = riskTolerance <= 3 ? 'conservative' : riskTolerance <= 5 ? 'moderate' : riskTolerance <= 7 ? 'growth' : 'aggressive';
  systemPrompt += '\n\nThe investor has a ' + riskLabel + ' risk profile (tolerance: ' + riskTolerance + '/10). Tailor your advice accordingly.';

  const userMessage = promptType === 'custom'
    ? 'Portfolio:\n\n' + JSON.stringify(portfolioSummary, null, 2) + '\n\nQuestion: ' + portfolioSummary.customQuestion
    : 'Portfolio:\n\n' + JSON.stringify(portfolioSummary, null, 2) + '\n\nAnalyze this portfolio.';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 4096, system: systemPrompt, messages: [{ role: 'user', content: userMessage }], stream: true }),
    });

    if (!response.ok) { const err = await response.json().catch(()=>({})); throw new Error(err.error?.message || 'API error: ' + response.status); }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '', buffer = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const d = line.slice(6).trim();
          if (d === '[DONE]') continue;
          try {
            const parsed = JSON.parse(d);
            if (parsed.type === 'content_block_delta' && parsed.delta?.text) {
              fullText += parsed.delta.text;
              const el = responseEl.querySelector('.ai-content');
              if (el) { el.innerHTML = renderMarkdown(fullText); el.classList.add('streaming-cursor'); responseEl.scrollTop = responseEl.scrollHeight; }
            }
          } catch(e) {}
        }
      }
    }
    const el = responseEl.querySelector('.ai-content');
    if (el) { el.innerHTML = renderMarkdown(fullText); el.classList.remove('streaming-cursor'); }
    responseEl.classList.remove('loading');
  } catch(err) {
    console.error('Analysis error:', err);
    responseEl.innerHTML = '<div class="ai-content" style="color:var(--red)"><strong>Error:</strong> ' + escapeHtml(err.message) + '</div>';
    responseEl.classList.remove('loading');
    showToast('Analysis failed: ' + err.message, 'error');
  }
  resetAnalyzeBtn();
}

function resetAnalyzeBtn() {
  const btn = document.getElementById('btnAnalyze');
  btn.disabled = !apiKey || filteredPositions.length === 0;
  btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg> Analyze';
}

function buildPortfolioSummary() {
  const totalValue = filteredPositions.reduce((s,p) => s + (p.market_value || p.value || 0), 0);
  const totalBook = filteredPositions.reduce((s,p) => s + (p.book_value || p.market_value || p.value || 0), 0);
  const byAccount = {};
  filteredPositions.forEach(pos => {
    const acct = pos._accountName || 'Unknown';
    if (!byAccount[acct]) byAccount[acct] = [];
    byAccount[acct].push({
      symbol: pos.security?.symbol || pos.symbol || 'N/A',
      name: pos.security?.name || '',
      quantity: pos.quantity,
      book_value: pos.book_value ? Math.round(pos.book_value*100)/100 : null,
      market_value: Math.round((pos.market_value||pos.value||0)*100)/100,
      currency: pos.security?.currency || pos.currency || 'CAD',
      type: pos.security?.type || '',
    });
  });
  return {
    total_market_value_cad: Math.round(totalValue*100)/100,
    total_book_value_cad: Math.round(totalBook*100)/100,
    unrealized_gain_loss: Math.round((totalValue-totalBook)*100)/100,
    number_of_accounts: [...new Set(filteredPositions.map(p => p._accountName))].length,
    number_of_positions: filteredPositions.length,
    accounts: byAccount,
  };
}

// ─── Markdown Renderer (improved) ───────────────────────────────────────────
function renderMarkdown(text) {
  let html = escapeHtml(text);
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  html = html.replace(/^---$/gm, '<hr>');
  html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>[\s\S]*?<\/li>)/g, function(match) { if (!match.startsWith('<ul>')) return '<ul>' + match + '</ul>'; return match; });
  html = html.replace(/<\/ul>\s*<ul>/g, '');
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  html = html.replace(/\n\n/g, '</p><p>');
  html = '<p>' + html + '</p>';
  html = html.replace(/\n/g, '<br>');
  html = html.replace(/<p>\s*<\/p>/g, '');
  html = html.replace(/<p>\s*(<h[123]>)/g, '$1');
  html = html.replace(/(<\/h[123]>)\s*<\/p>/g, '$1');
  html = html.replace(/<p>\s*(<ul>)/g, '$1');
  html = html.replace(/(<\/ul>)\s*<\/p>/g, '$1');
  html = html.replace(/<p>\s*(<hr>)/g, '$1');
  html = html.replace(/(<hr>)\s*<\/p>/g, '$1');
  return html;
}

// ─── Settings ────────────────────────────────────────────────────────────────
function toggleSettings() {
  const panel = document.getElementById('settingsPanel');
  panel.classList.toggle('visible');
  if (panel.classList.contains('visible')) document.getElementById('apiKeyInput').focus();
}

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { showToast('Enter an API key', 'error'); return; }
  apiKey = key;
  if (addon) {
    addon.saveData({ apiKey: key }).then(() => { showToast('API key saved', 'success'); updateStatus('connected', 'API key saved'); }).catch(err => { showToast('Key set for session', 'error'); });
  } else { showToast('API key set for session', 'success'); updateStatus('connected', 'API key set'); }
  document.getElementById('settingsPanel').classList.remove('visible');
  document.getElementById('btnAnalyze').disabled = filteredPositions.length === 0;
}

function onPromptChange() {
  const val = document.getElementById('promptSelect').value;
  document.getElementById('customPromptArea').classList.toggle('visible', val === 'custom');
  if (val === 'custom') document.getElementById('customPrompt').focus();
}

// ─── Utilities ───────────────────────────────────────────────────────────────
function updateStatus(status, title) {
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot ' + status;
  dot.title = title || status;
}

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type||'') + ' visible';
  setTimeout(() => t.classList.remove('visible'), 3000);
}

// ─── Demo Data ───────────────────────────────────────────────────────────────
function loadDemoData() {
  portfolioData = {
    positions: [
      { security: { symbol: 'VFV.TO', name: 'Vanguard S&P 500 ETF', currency: 'CAD', type: 'etf' }, quantity: 500, book_value: 42500, market_value: 55200, _accountName: 'TFSA - Questrade' },
      { security: { symbol: 'XQQ.TO', name: 'iShares NASDAQ 100 ETF', currency: 'CAD', type: 'etf' }, quantity: 200, book_value: 18000, market_value: 24800, _accountName: 'TFSA - Questrade' },
      { security: { symbol: 'XEQT.TO', name: 'iShares Core Equity ETF', currency: 'CAD', type: 'etf' }, quantity: 800, book_value: 20000, market_value: 22400, _accountName: 'RRSP - RBC DI' },
      { security: { symbol: 'CSH.UN.TO', name: 'Cornerstone Capital Resources', currency: 'CAD', type: 'equity' }, quantity: 15000, book_value: 3000, market_value: 18000, _accountName: 'Non-Reg - Questrade' },
      { security: { symbol: 'BTC', name: 'Bitcoin', currency: 'USD', type: 'crypto' }, quantity: 0.75, book_value: 28000, market_value: 48500, _accountName: 'Shakepay' },
      { security: { symbol: 'TD.TO', name: 'Toronto-Dominion Bank', currency: 'CAD', type: 'equity' }, quantity: 150, book_value: 12750, market_value: 12300, _accountName: 'RRSP - RBC DI' },
      { security: { symbol: 'ENB.TO', name: 'Enbridge Inc', currency: 'CAD', type: 'equity' }, quantity: 200, book_value: 9800, market_value: 11200, _accountName: 'Non-Reg - Questrade' },
      { security: { symbol: 'XEF.TO', name: 'iShares MSCI EAFE ETF', currency: 'CAD', type: 'etf' }, quantity: 300, book_value: 9600, market_value: 10500, _accountName: 'RRSP - RBC DI' },
    ],
    institutions: [
      { _id: '1', name: 'Questrade' },
      { _id: '2', name: 'RBC Direct Investing' },
      { _id: '3', name: 'Shakepay' },
    ],
    totalValue: 0, totalBook: 0,
  };
  let tv = 0, tb = 0;
  portfolioData.positions.forEach(p => { tv += p.market_value || 0; tb += p.book_value || 0; });
  portfolioData.totalValue = tv;
  portfolioData.totalBook = tb;
  filteredPositions = [...portfolioData.positions];
  populateAccountFilter();
  renderAllTabs();
  document.getElementById('btnAnalyze').disabled = !apiKey;
}

// ─── Chart.js Defaults ──────────────────────────────────────────────────────
if (typeof Chart !== 'undefined') {
  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = 'rgba(42, 53, 80, 0.5)';
  Chart.defaults.font.family = "'DM Sans', sans-serif";
}

// ─── Event Listeners ─────────────────────────────────────────────────────────
document.getElementById('apiKeyInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') saveApiKey(); });
document.getElementById('customPrompt').addEventListener('keydown', function(e) { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') runAnalysis(); });
</script>
</body>
</html>
